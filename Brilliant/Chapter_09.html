<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Chapter 9 - Brilliant</title>
	<link rel="stylesheet" type="text/css" href="../libs/style.css">
	<link rel="stylesheet" type="text/css" href="../libs/prettify.css">
	<script src="../libs/run_prettify.js?autoload=true&amp;lang=css" defer=""></script>
	<script type="text/javascript" src="../libs/three.js"></script>
	<script type = "text/javascript" src = "../libs/dat.gui.js"></script>
	<script src = "../libs/OrbitControls.js"></script>
	<script src = "../libs/WebGeometry.js"></script>
	<script src = "../libs/polyhedron.js"></script>
	<script src = "brilliant_verts.js"></script>
	<script src = "brilliant.js"></script>
	
	<style>
		#div_out_big
		{
			position: relative;
			width: 1075px;
			height: 525px;
			left: 0px;
			background-color: #aaffff;
			border: solid 2px;
		}
		#div_in_big
		{
			position: absolute;
			left: 5px;
			top: 5px;			
			height: 410px;
			width: 1145px;
			background-color: #eeffee;
			border: solid 2px;
		}
		#div_pars_big
		{
			position: absolute;
			left: 530px;
			top: 2px;			
			height: 515px;
			width: 280px;
			background-color: #eeeeaa;
			border: solid 2px;
		}
		#gui_container_big
		{
			position: absolute;
			left: 820px;
			top: 5px;
		}
	</style>
</head>

<body>

<h3 align = "center">&emsp;&emsp;
<a href="../Octagon/Chapter_08.html"> <span class=brown>Глава 8 </span></a>  <span class=brown>&ensp;◄</span>
&emsp;&emsp;&emsp;
<a href="../index.html"> <span class=brown> Содержание  </span></a>
&emsp;&emsp;&emsp;
 <span class=brown>► &ensp;</span><a href="../Sunflower/Chapter_10.html"> <span class=brown> Глава 10  </span></a>
</h3>

<h2 align = "center"> Three.js и геометрия. &ensp; Глава 9. &ensp; Классический бриллиант</h2>

<p>
В данном разделе мы создадим модель многогранника, который называется бриллиантом. 
<p>
<br>
<div id="div_out_big"> 
		<canvas id="canvas" width="522" height="522" style="border: 1px solid"></canvas>
		<div id="div_pars_big" >
			<canvas id="canvas_pars" width="280" height="480"></canvas>
			<div id="div_input">
				                     <input type="radio" name="numeration" id = "btn_no"  />No
				&nbsp&nbsp&nbsp&nbsp <input type="radio" name="numeration" id = "btn_all" />All
				&nbsp&nbsp&nbsp&nbsp <input type="radio" name="numeration" id = "btn_cr_gd_pav"  />Cr-Gd-Pav
			</div>		
		</div>
		<div id="gui_container_big" ></div> 
</div>

<h3 align = "center"> Нумерация вершин и обозначение граней модели </h3>
<p>
Самыми распространенными на сегодняшний момент являются  
<b><a href="http://diamond3d.ucoz.ru/Brilliant/Brilliant_wireframe_trackball.html" target="_blank">круглые бриллианты</a></b>
с <b>57</b> гранями. Бриллиант - это самая известная огранка. Больше половины всех бриллиантов в мире приходится, на камни круглой формы.
По ссылке  <b><a href="http://diamond3d.ucoz.ru/Dispersion/Brilliant_D.html" target="_blank">Brilliant - Light Dispersion</a></b>  
можно увидеть круглый бриллиант отображенный при помощи кубических карт. При нажатии на приведенной по ссылке 
странице кнопки <b>Inverse</b> многогранник отобразится на черном фоне.
</p>
<p>
Если растянуть многогранник вдоль одной из осей в горизонтальной плоскости то можно получить огранку которая имеет 
название <b><a href="http://diamond3d.ucoz.ru/Oval/Oval_wireframe_trackball.html" target="_blank">овал</a></b>.
Существует еще один вариант подобных многогранников. Это 
<b><a href="http://diamond3d.ucoz.ru/MoonOval/MoonOval_wireframe_trackball.html" target="_blank">овал с лунными гранями</a></b> 
(лунные грани будут подробно рассмотрены в следующих главах). 
Подобный многогранник можно увидеть еще и по ссылке  при помощи кубических карт
<b><a href="http://diamond3d.ucoz.ru/Dispersion/MoonOval_D.html" target="_blank">MoonOval - Light Dispersion</a></b>.
</p>
<p>
Как и большинство других огранок, бриллиант состоит из трех частей – короны (верхняя часть многогранника), 
рундиста (средняя часть многогранника)  и павильона (нижняя часть многогранника).   
Схематичные изображения короны и павильона, а также нумерация вершин показаны на рисунках <b>1, 2, 3</b> и <b>4</b>.
На рисунке <b>1</b> показана нумерация вершин короны при взгляде на нее сверху, а на рисунке <b>2</b> - нумерация вершин павильона
при взгляде на него снизу и наблюдателе находящимся снаружи модели. Если в программе повернуть модель
соответствующим образом, то при запущенном режиме индикации номеров вершин, мы увидим ту же нумерацию, что мы видим 
на рисунках <b>1</b> и <b>2</b>.
</p>
<img src = "Figure_9_1_2.png"  >
<p>
Однако, иногда требуется сопоставить нумерацию вершин короны и павильона. В этом случае удобно представить, что наблюдатель
смотрит на павильон сверху находясь внутри модели.  На корону он смотрит также сверху. Нумерация вершин при таком расположении
наблюдателя показана на рисунках <b>3</b> и <b>4</b>. Мы видим что номера вершин павильона на рисунке сответствуют номерам
вершин короны в большей степени, чем на рисунках <b>1</b> и <b>2</b>. Построение программы для отображения модели при 
наличии рисунка <b>4</b> окажется более наглядным. Например, из трехмерной модели многогранника видно, 
что грань <b>b</b> павильона расположена под гранью <b>B</b> короны. Когда мы изображаем павильон так, 
как если бы смотрели на него снаружи (рисунок <b>2</b>), требуемого соответствия положений граней короны и павильона нет.
</p>
<p>
Отметим еще, что в дальнейшем грани короны мы будем обозначать заглавными латинскими буквами, а павильона - прописными.
На рисунках используется отдельная нумерация для вершин короны, рундиста и павильона. Для того чтобы увидеть сквозную
нумерацию всех вершин требуется нажать на панели управления кнопку "<b>All</b>".
</p>
<img src = "Figure_9_3_4.png" class="center-img" >

<p>
Основной гранью короны является площадка. На рисунках она обозначена как <b>Table</b>. Обычно она является самой крупной гранью 
при любой форме огранки алмаза и расположена перпендикулярно оси бриллианта. 
Площадка играет основную роль как источник блеска и игры бриллианта. Грани, обозначенные на рисунках 
как <b>J, K, L, M, N, P, Q</b> и <b>R</b> называются гранями звезды или верхними клиньями короны. 
Грани звезды примыкают к площадке. В бриллиантовой огранке их <b>8</b> и при просмотре сверху они, 
сочетаясь с площадкой, выглядят как звезда. Площадку и восемь граней звезды можно представить как объединение двух фигур, 
каждая из которых по форме подобна квадрату (рисунок <b>3</b>).
Первый квадрат образует площадка и грани <b>J, L, N</b> и <b>Q</b>, а второй – площадка и грани <b>K, M, P</b> и <b>R</b>. 
Для задания степени отклонения этих фигур от истинных квадратов в бриллианте, а также в огранках, 
у которых форма короны подобна форме короны бриллианта, вводится специальный параметр имеющий название 
<b>Square table</b>. Значение этого параметра напрямую определяет значение другого, очень важного, для многогранника бриллиант параметра, 
а именно параметра, который называется <b>Star  facets</b>. 
Связь между этими двумя параметрами мы подробно рассмотрим в дальнейшем. 
У правильно построенного круглого бриллианта, у которого значение удлинения равно <b>1.0</b>, 
значение параметра <b>Square table</b> должно быть равно 0. В этом случае все верхние клинья короны имеют одинаковый размер.
На короне, показанной на рисунке <b>3</b>, при помощи жирных линий выделены два упомянутых квадрата, 
развернутых относительно друг друга на <b>45º</b>. Площадка этого многогранника очень близка по форме к правильному восьмиугольнику.
</p>
<p>
Восемь четырехугольных граней <b>A, B, C, D, E, F, G</b> и <b>H</b> называются основными гранями короны. 
Они простираются от площадки до рундиста. Восемь пар граней короны, обозначенных на рисунках как <b>A1, A2, B1, B2 . . . H1, H2</b>, 
называются клиньями верха или нижними клиньями короны.
</p>

<p>
Заметим, что форма короны очень многих типов огранок, подобна форме короны бриллианта. 
Прежде всего, это относится к огранкам типа маркиз и груша. 
Корона огранки сердце также во многом подобна короне бриллианта, хотя и имеет больше граней. 
Форма короны огранок типа "подушка" (<em>cushion</em>) также подобна короне бриллианта. 
Однако, хотя ничто не мешает рассчитать положение вершин короны подушки точно таким же способом, 
который мы использовали для бриллианта, обычно используется совершенно иной способ ее построения. 
Короны треугольных и, даже, пятиугольных огранок, также во многом похожи на корону бриллианта. 
Исходя из вышесказанного, можно считать форму короны огранки бриллиант наиболее часто 
используемой и для большинства других типов огранок.
</p>

<p>
Рундист реальной огранки при ее создании стараются максимально приблизить по форме к цилиндру, 
направляющей которого является <em>окружность</em>. Если огранка имеет удлинение, то очень желательно, 
чтобы рундист максимально приближался по форме к цилиндру с направляющей в виде <em>эллипса</em>. 
</p>

<p>
В модели бриллианта необходимо сделать аппроксимацию цилиндра, представляющего рундист, 
набором плоских, вертикально расположенных, граней. Обычно для аппроксимации рундиста бриллианта 
используется <b>32, 64</b> или <b>128</b> граней. В нашей модели мы будем использовать в качестве 
рундиста <b>64</b> грани, которые вписаны в соответствующий цилиндр. Заметим, что не только в моделях, 
но и в реальных огранках, также иногда делают фацетированный рундист. 
Фацетированный рундист  – это рундист, поверхность которого покрыта гранями. 
Обычно фацетированный рундист создают у достаточно крупных алмазов, 
у которых вес превышает, по крайней мере, 0.7 карата.
</p>
<p>
Грани <b>a, b, c, d, e, f, g</b> и <b>h</b> называются основными гранями павильона. 
В тех многогранниках, где эти восемь граней сведены в самой нижней своей части в одну точку (<em>шип</em>), 
эти грани представляют собой четырехугольники. В огранках, где присутствует грань калетты, 
эти грани являются пятиугольниками, а точка пересечения плоскостей, в которых лежат эти грани, 
обычно называют или виртуальным шипом или виртуальной калеттой огранки.
</p>
<p> 
В идеальном бриллианте центры площадки, рундиста и шип (или центр плоскости калетты) 
должны лежать на оси симметрии бриллианта. Иногда, исходя из заготовки для бриллианта, 
калетта или шип может незначительно отклоняться от оси симметрии бриллианта. 
Плоскость, в которой лежит калетта, также как и площадка огранки, должна быть  
расположена перпендикулярно (<em>это важно</em>) оси бриллианта, которая совпадает с осью <b>Z</b>. 
При создании программы мы рассмотрим построение такой огранки, в которой присутствует грань калетты 
и предусмотрена возможность задания значения смещения центра калетты 
от вертикальной оси огранки в горизонтальной плоскости - примерно также 
как это сделано для модели октагона (глава <b>6</b>).
<p>
Грани павильона <b>a1, a2, b1, b2 . . . h1, h2</b>, которые примыкают к рундисту, 
называются клиньями павильона. Внешний вид павильона очень в большой степени зависит от того, 
насколько близко к калетте находятся точки пересечения плоскостей в которых лежат клинья павильона с плоскостями, 
в которых расположены основные грани павильона <b>a, b c, d, e, f, g</b> и <b>h</b>. 
Параметр, определяющий координату <b>Z</b> этих точек (применительно к павильону будем говорить 
о "глубине" этих точек), называется <b>Lower facets depth</b>. Этот параметр задает в процентах
глубину указанных точек относительно глубины павильона.
</p>

<p>
Корона многогранника состоит из <b>33</b> граней (с учетом грани площадки), а павильон – из <b>24</b> граней. 
Если нижняя часть павильона ограничена плоскостью калетты, то к числу граней павильона добавляется 
еще одна восьмиугольная грань. Таким образом, общее количество граней у бриллианта равно 
при наличии грани калетты <b>58</b> (грани рундиста при подсчете не учитываем). 
Как уже говорилось выше, у идеального бриллианта размер калетты обычно или очень мал 
или нижние грани павильона вообще сведены в одну точку – шип огранки. 
В последнем случае общее число граней бриллианта равно <b>58 – 1 = 57</b>.
</p>

<h3 align = "center"> Структура данных модели (СДМ) многогранника бриллиант </h3>
Структура данных модели бриллианта содержит следующие параметры:
<pre class="prettyprint" id="quine">
// СДМ - структура данных модели
var lw = 1.0;                  // отношение длины огранки к ее ширине
          // Рундист
var r = 0.2;                   // толщина рундиста
var square_deviation = 0.0001; // квадратичность рундиста
          // Корона
var beta = 30*DEGREE;          // угол наклона граней короны 
                               // A - H к горизонтальной плоскости OXY
var t = 0.57;                  // ширина площадки (по оси OY)
var dSquare = 0.0001;          //   величина значения отличия от квадратов,
                               // многоугольников, которые состоят 
                               // из площадки и граней звезды
// Павильон
var alpha = 50*DEGREE;         //  угол наклона граней павильона a - h 
                               // к горизонтальной плоскости
var hPavFacet = 0.60;          // глубина нижних вершин фасет павильона
// Калетта
var culet = 8*PERCENT;         // размер калетты
var culet_R = 0.00001;         // смещение калетты в процентах от диаметра
var culet_A = 0*DEGREE;        // направление (азимут) смещения калетты
// Азимуты примыкающих к рундисту граней
var up_az = 11.25*DEGREE;      // азимут граней короны A1, A2, B1, B2 ...
var low_az = 11.25*DEGREE;     // азимут граней павильона a1, a2, b1, b2 ...

</pre>

<h3 align = "center"> Построение рундиста бриллианта </h3>
<p>
Первым этапом построения практически любой огранки является вычисление координат вершин рундиста. 
В качестве направляющей для цилиндра, на основе которого строится рундист бриллианта, обычно берется окружность. 
Если бриллиант имеет удлинение не равное <b>1.0</b> вдоль оси <b>OX</b>, то в качестве направляющей цилиндра используется эллипс. 
Как известно,  любой эллипс при одинаковом значении длины его двух главных осей превращается в окружность. 
Поэтому чтобы при желании можно было из идеального круглого бриллианта сделать бриллиант 
со значением удлинения огранки (<b>lw</b>) не равной <b>1.0</b>, будем строить огранку с эллиптическим рундистом.
Также возможен вариант когда вместо окружности или эллипса берется суперэллипс (<em>кривая Ламе</em>).
Построение суперэллипса было подробно рассмотрено в главе <b>4</b>. 
</p>

<p>
Расчет вершин рундиста происходит в функции <code>InitGirdle</code> находящейся в файле <b>brilliant_verts.js</b>.
Она вызывается в самом начале работы функции <code>VerticesCalculation</code> в которой расчитываются 
координатывсех вершин модели.
В результате своей работы <code>InitGirdle</code> формирует массив girdle из <b>128</b> вершин рундиста. 
Все верхние <b>64</b> вершины рундиста имеют одинаковое значение координаты <b>Z</b> равное значению <b>r/2</b>, 
а все нижние <b>64</b> вершины рундиста имеют значение координаты <b>Z</b> равное <b>-r/2</b>. 
В дальнейшем, после построения короны и павильона огранки, координаты вершин рундиста 
по оси <b>OZ</b> корректируются.
</p>

<h3 align = "center"> Построение короны </h3>

<p>
Создание короны и павильона модели бриллианта происходит в рамках функции <code>VerticesCalculation</code>.
Назначением этой функции является расчет координат вершин модели, которые используются 
для отображения огранки на экране дисплея. После того как координаты вершин рундиста расчитаны
в функции <code>InitGirdle</code>, определяются координаты вершин короны.
</p>
<p>
Перед тем как перейти к рассмотрению расчета координат вершин короны рассмотрим набор параметров, 
которые определяют ее форму и размеры. Параметр <b>Crown angle</b> задает угол наклона грани <b>A</b> короны. 
Этому параметру соответствует поле <code>beta</code> в <b>СДМ</b>. Если огранка круглая (<b>lw = 1.0</b>), то все главные 
грани короны будут иметь наклон равный наклону грани <b>A</b>. Если огранка имеет удлинение (<b>lw ≠ 1.0</b>), 
то только грани <b>A</b> и <b>E</b> короны будут иметь наклон равный значению <b>beta</b>. Все остальные главные грани 
короны будут в этом случае иметь наклон меньший, чем значение <b>beta</b>. 
Параметр <b>Table</b> задает ширину площадки. Она равна расстоянию между вершинами <b>0</b> и <b>4</b> модели. 
Для хранения значения этого параметра в <b>СДМ</b> вводится поле <code>t</code>.
</p>
<p>
Параметр <b>Square table</b> задает положение точек (вершин) звезды <b>8, 9, . . . 15</b> короны огранки. 
Хотя про смысл этого параметра уже говорилось ранее, но в связи с тем, что его значение во многом 
определяет правильность построения короны, повторим сказанное еще раз. 
Для его значения в <b>СДМ</b> введено специальное поле <code>dSquare</code>. 
Если посмотреть на рисунок 3 то можно увидеть, что вершины <b>0, 9, 11, 13</b> а также вершины <b>8, 10, 12, 14</b> 
лежат в углах двух четырехугольников. Значение <b>dSquare</b> задает степень отличия этих четырехугольников от квадратов. 
При значении dSquare равном <b>0</b> и при значении параметра lw равном <b>1.0</b>, четырехугольники становятся квадратами. 
При значениях параметра dSquare отличных от нулевого значения, квадраты начинают ломаться 
и превращаются в многоугольники. Значение параметра <b>dSquare</b> используется для расчета  значения другого 
очень важного параметра <b>Star facets</b>. Рассмотрение этого параметра будет немного позже. 
Таким образом, значения трех параметров – <b>beta, t</b> и <b>dSquare</b>, совместно со значениями 
еще двух параметров – <b>lw</b> и <b>square_deviation</b>, полностью определяют форму короны. 
</p>
<img src = "Figure_9_5_6.png" class="center-img" >
<p>
Для того чтобы построить корону огранки обратим внимание на тот факт, что для идеального бриллианта плоскости, 
в которых лежат основные грани короны <b>A, B, . . ., H</b> пересекаются в одной точке. На рисунке <b>5</b> эта точка обозначена как <b>UpPoint</b>.
  Высота <em>upPoint</em> этой точки равна:
<br>
    &emsp;&emsp;<code>upPoint = r / 2 + h1 = r / 2 + 0.5 &middot; tan(&beta;)</code>
<br>							
Очевидно, что для идеального бриллианта, проекция точки UpPoint на горизонтальную плоскость должна лежать в начале координат и, 
поэтому, координаты точки <b>UpPoint</b> для идеального бриллианта равны <b>(0, 0, upPoint)</b>. Высота короны на рисунке <b>5</b> обозначена 
как hCrown и вычисляется она, как можно увидеть из рисунка <b>5</b>, по следующей формуле
<br>
    &emsp;&emsp;<code>hCrown = tan(&beta;)&middot;(1 - t)/2</code>
<br>
Угол наклона <b>beta</b> грани <b>A</b> короны обозначен на рисунке буквой &beta;. Координаты лежащих на площадке вершин  короны 
<b>0, 1, 2, . . . 7</b>  можно найти, если определить точки пересечения прямых, проведенных через точку <b>UpPoint</b>, 
и вершины рундиста <b>0, 8, 16, 24, 32, 40, 48, 56</b>  (рис.<b>6</b>) с плоскостью в которой лежит площадка. 
Эта плоскость расположена параллельно (<em>это важно</em>) плоскости <b>OXY</b> на высоте равной сумме значений <b>r/2</b> и <b>hCrown</b>. 
Вспомним, что когда мы создавали огранку октагон (глава <b>6</b>) то при ее построении мы использовали точку UpPoint,
которую можно было смещать в горизонтальной плоскости. Для короны бриллианта также можно ввести 
при желании эту возможность, но обычно это не делается. 
</p>
<p>
Для нахождения координат вершин короны принадлежащих площадке можно поступить и по-иному. 
Представим восемь прямых проходящих через точку <b>UpPoint</b>, как пучок прямых пересекающихся в этой точке. 
Если обрезать эти прямые с одной стороны точкой их точкой пересечения <b>UpPoint</b>, 
а с другой стороны плоскостью, проходящей через верхние вершины рундиста,  
то  плоскость, проходящая через точки <b>B – B′</b> (рис.<b>5</b>)  разделит получившиеся в результате такого 
обрезания отрезки прямых в отношении, определяемом размером площадки <b>t</b>. Исходя из этого, 
можно найти координаты вершин принадлежащих площадке. 
</p>
<p>
Для нахождения координат вершин <b>8, 9, . . . 15</b> звезды огранки поступим следующим образом. 
Так как плоскости, в которых лежат главные грани короны, пересекаются в одной точке, 
то из этого следует, что и линии пересечения плоскостей, в которых лежат эти грани, также пересекутся в одной точке. 
На рисунке <b>6</b> этим линиям пересечения соответствуют прямые, по которым пересекаются грани <b>A</b> и <b>B</b>, <b>B</b> и <b>C</b> и т.д. 
Для определения положения этих прямых нам необходимо, для каждой из них, найти по две точки принадлежащей прямой. 
Очевидно, что в качестве первой точки можно взять точку <b>UpPoint</b> с координатами <b>(0, 0, <em>upPoint</em>)</b>. 
Эта точка принадлежит одновременно  всем прямым, по которым пересекаются плоскости, в которых лежат главные грани короны. 
Для определения для каждой прямой, второй точки, которая принадлежит этой прямой, проведем касательные 
(рисунок <b>6</b>) к рундисту в его вершинах <b>0, 8, 16, 24, 32, 40, 48</b> и <b>56</b>. Точки пересечения этих касательных, взятые попарно, 
и будут являться искомыми точками. На рисунке <b>6</b> это точки обозначены <b>pt4, pt12, pt20, pt28, pt36, pt44, pt52</b> и <b>pt60</b>, 
так как они расположены напротив вершин рундиста с соответствующими индексами. 
</p>
<p>
Таким образом, мы получили восемь отрезков, каждый из которых соединяет
точку <b>UpPoint</b> с одной из точек пересечения касательных к рундисту.
Затем  полученные отрезки пересекаются горизонтальной плоскостью, 
чтобы разделить их на две части в определенном отношении. 
Величина этого отношения вычисляется при помощи значения <b>dSquare</b>. На рисунке <b>6</b> показано как отрезок 
соединяющий точку <b>O</b> с точкой <b>pt20</b> пересечения касательных к рундисту, разделен на два отрезка. 
Один отрезок ограничен точкой <b>O</b> и вершиной короны <b>10</b>, а второй отрезок ограничен вершиной короны <b>10</b> 
и точкой <b>pt20</b> пересечения касательных к рундисту. Не следует только при этом забывать, что на рисунке <b>6</b> 
изображены не сами отрезки прямых, а только их <b><em>проекции</em></b> на горизонтальную плоскость. 
При этом точка <b>UpPoint</b> проектируется в точку <b>O</b>, лежащую в начале системы координат, в которой задается огранка. 
Естественно возникает вопрос – а как определить уравнения касательных в заданных вершинах рундиста? 
Для решения этой задачи поступим следующим образом. 
</p>

<p>
Найдем направляющий вектор отрезка, соединяющего две вершины рундиста, ближайшие к той его вершине, 
через которую требуется провести касательную. Причем эти две вершины, через которые проходит отрезок, 
должны лежать по разные стороны от вершины рундиста через которую проводится касательная.  
Исходя из построенного отрезка, находим его направляющий вектор. 
Теперь у нас есть все необходимые составляющие, чтобы составить уравнение касательной 
к рундисту на плоскости – направляющий вектор касательной и точка (вершина рундиста), 
через которую эта касательная проходит.
</p>
<p>
Исходный текст той части функции <code>VerticesCalculation</code>, в которой происходит вычисление положения вершин короны.
</p>

<pre class="prettyprint" id="quine">
	// Конструируем корону
	var r_tan_beta = 0.5 * Math.tan (beta); // beta - угол наклона граней короны
	var H1 = r/2;	// уровень верхней части рундиста
	var H2 = -r/2;	// уровень нижней части рундиста
	//  точки короны пропорциональны точкам рундиста относительно upPoint (это следует
	// из предположения, что все грани пересекаются в одной точке)
	var upPoint = new Point3D(0.0, 0.0, H1 + r_tan_beta);

	for ( i = 0; i < 8; i++ )
	{
		var dir = new Vector3D(	girdle[i*8][0] - upPoint[0], 
					girdle[i*8][1] - upPoint[1], 
					girdle[i*8][2] - upPoint[2]);
		// Вектор dir нельзя нормировать !
		var pt = new Point3D(upPoint[0] + t * dir[0], upPoint[1] + t * dir[1], upPoint[2] + t * dir[2]);
		crown[i] = pt;
	}

	//  Находим точки пересечения основных граней  
	// короны между собой на уровне рундиста.
	// Сначала создаем прямые касательныые к рундисту
	var line = [];
	var dir = new Vector2D(girdle[1][0] - girdle[63][0], girdle[1][1] - girdle[63][1] );
	dir.Normer();
	var pt = new Point2D(girdle[0][0], girdle[0][1]);
	var ln = new Line2D();
	ln.CreateLineVectorPoint(dir, pt);
	line[0] = ln;
	
	for ( i = 1; i < 8; i++ ) 
	{
		var dir = new Vector2D(girdle[i*8+1][0] - girdle[i*8-1][0], girdle[i*8+1][1] - girdle[i*8-1][1]);
		dir.Normer();
		var pt = new Point2D(girdle[i*8][0], girdle[i*8][1]);
		var ln = new Line2D();
		line[i] = ln;
		ln.CreateLineVectorPoint(dir, pt); // касательные к линии рундиста
	}
	
	// Точки пересечения предыдущих касательных между собой
	var g2 = [];
	for ( i = 0; i < 8; i++ )
	{
		var pt = line[i].IntersectionTwoLines(line[(i+1)%8]);
		g2[i] = pt;
	}
	
	// Точки звезды (вершины короны) пропорциональны  точкам g2 относительно upPoint
	// Коэффициент пропорциональности m находим по следующей формуле
	var m = (1 + SQRT2) / 2 * t; // SQRT2 = 1.41421356237309504880
	if ( dSquare <= 0 ) 
		m = m + dSquare * (m - 1 + t);
	else 
		m = m + dSquare * (1-m);
	// Координаты вершин звезды
	for ( i = 0; i < 8; i++ )
	{
		var dir = new Vector3D( g2[i][0] - upPoint[0], g2[i][1] - upPoint[1], H1 - upPoint[2] );
		var pt = new Point3D( upPoint[0] + m * dir[0], upPoint[1] + m * dir[1], upPoint[2] + m * dir[2] );
		crown[i+8] = pt;
	}
</pre>	

<h3 align = "center"> Параметр Star Facets </h3>

<img src = "Figure_9_7.png" class="center-img" >
<p>
Параметр <b>Star facets</b> определяет относительное положение вершин звезды короны по отношению 
к положению вершин площадки и рундиста. Как он расчитывается показано на рисунке 7.
</p>
<p>
Параметр <b>Star facets</b> для бриллианта не имеет своего поля для хранения значения в <b>СДМ</b> 
и является вычисляемым параметром. Его значение определяется исходя из величины параметра <b>Square table</b>, 
который представлен в <b>СДМ</b> полем <code>dSquare</code>. Для большинства типов огранок, 
в том числе и для бриллианта параметр <b>Star facets</b>  является очень важным параметром. 
Поэтому желательно не только получать его значение, но и иметь возможность устанавливать его. 
К сожалению, если получение значения параметра <b>Star facets</b> не представляет затруднений, 
то установка его значения для многих типов огранок, в том числе и для бриллианта, 
связана со значительными трудностями.
<p>
Для бриллианта задать значение параметра <b>Star facets</b> можно только изменив соответствующим образом 
значение <code>dSquare</code>. Для подобной установки требуется некоторая вспомогательная функция. 
Мы не будем создавать такую функцию для данной модели. Скажем только, что в эту функцию должно передаваться 
значение параметра <b>Star facets</b>, которое требуется установить и, 
методом последовательных итераций, должно находиться значение <code>dSquare</code>, 
соответствующее заданному значению параметра <b>Star facets</b>. 
</p>
<p>
Заметим, что жесткая привязка значения параметра <b>Star facets</b> к значению <code>dSquare</code> проистекает только 
из принятого нами способа построения короны бриллианта. Принятый нами способ построения огранки 
очень хорошо подходит для круглого бриллианта, так как он идеально отражает присущую круглому бриллианту геометрию.  
Для других огранок, например огранок типа подушка (<em>cushion</em>), хотя форма короны для них на первый взгляд 
выглядит очень похожей на форму короны бриллианта, способ построения короны мы изберем совершенно другой. 
Связано это с тем, что хотя корона бриллианта и корона подушки имеет одно и то же количество ребер и вершин, 
они построены по-разному. Объясняется это тем, что  линии рундистов этих огранок создаются, 
исходя из различных геометрических предпосылок. Соответственно это влечет за собой и различия в способах деления 
рундистов бриллианта и подушки на сегменты. И хотя при желании можно построить корону 
<em>подушки</em> точно таким же способом, которым мы создали корону бриллианта, 
выглядеть она будет не самым лучшим образом. Поэтому в многогранниках типа подушка 
(и в подавляющем большинстве других), которые мы создадим в дальнейшем, 
уже не будет параметра <b>Square table</b> и соответствующего ему поля <code>dSquare</code> в <b>СДМ</b>, при этом значение параметра 
<b>Star facets</b> перейдет из разряда вычисляемых параметров в число параметров имеющих свое собственное поле в <b>СДМ</b>.
</p>
<pre class="prettyprint" id="quine">
	// Вычисление параметра "Star facets"
	var line_cr0_cr1 = new Line2D(new Point2D(crown[0][0], crown[0][1]), new Point2D(crown[1][0], crown[1][1]));
	var pt_cr8 = new Point2D(crown[8][0], crown[8][1]);
	var pt_g4 = new Point2D(girdle[4][0], girdle[4][1]);
	var d1 = line_cr0_cr1.Distance(pt_cr8);
	var d2 = line_cr0_cr1.Distance(pt_g4);	
	star_facets = d1 / d2;
</pre>	
<p> 
Значение параметра <b>Star facets</b> определяет вид короны, если смотреть на многогранник сверху со стороны короны. 
Одновременно, этот параметр неявно определяет высоту, на которой расположены вершины звезды (<b>8, 9,  . . . 15</b>) короны. 
Для большинства огранок, вне зависимости от того выполнен ли многогранник как бриллиант, маркиз, груша, подушка и даже сердце, 
предполагается что выполняется следующее правило:<br>
Если вершины короны огранки расположены таким образом, что вид короны подобен виду короны бриллианта, 
то независимо от того, каким способом выполнено построение короны, вершины <b>8, 9,  . . . 15</b> короны должны иметь одинаковую высоту.
В дальнейшем для любого типа огранок, а не только для бриллианта, вершины <b>8, 9,  . . . 15</b> короны будем называть вершинами звезды.
</p>
<p>
Если корона должна быть построена без учета приведенного выше правила, 
таким образом, что некоторые из вершин звезды могут иметь не одинаковую высоту, 
то это должно быть специально обговорено в спецификации на многогранник, который требуется создать, 
так как такое требование является исключением из общего правила построения короны многогранников огранок. 
</p>

<h3 align = "center"> Построение павильона огранки</h3>
<p>
Для задания формы павильона выберем следующие параметры и соответствующие им поля <b>СДМ</b>:
Параметр <b>Pavilion angle</b> и соответствующее ему поле <code>alpha</code> в <b>СДМ</b> задают 
угол наклона главных граней <b>a</b> и <b>e</b>  павильона, которые лежат в месте минимального диаметра многогранника. 
Если огранка круглая (<b>lw = 1.0</b>) и калетта павильона находится на оси симметрии огранки, 
то все главные грани павильона будут иметь наклон равный наклону грани <b>a</b>. 
Если многогранник имеет удлинение (<b>lw ≠ 1.0</b>), то только грани <b>a</b> и <b>e</b> короны будут иметь 
наклон равный значению поля <code>alpha</code> в <b>СДМ</b>. 
Все остальные главные грани короны будут в этом случае иметь наклон меньший, 
чем значение <code>alpha</code> (предполагаем, что калетта находится на ее оси симметрии).
</p>

<p> 
Наиболее сложным представляется случай, когда положение центра калетты смещено относительно оси симметрии 
огранки одновременно по оси <b>OX</b> и оси <b>OY</b>. В этом случае значение параметра <b>Pavilion angle</b> 
и соответствующее ему поле <code>alpha</code> в <b>СДМ</b> не будет совпадать со значениями угла 
наклона ни одной главной грани павильона. 
Что касается значения поля <code>alpha</code> в <b>СДМ</b>, то оно будет таким, как будто смещение калетты отсутствует. 
Значение угла <code>alpha</code> используется для определения глубины павильона и последующего за этим нахождения 
координат всех его вершин. Параметр <b>Pavilion angle</b> и два парметра, 
задающих смещение калетты – <b>Culet offset</b> и <b>Culet offset azimuth</b>, являются параметрами независящими друг от друга.
Если требуется получить истинные значения углов наклона граней <b>a, b</b> или какой-либо другой грани павильона для случая, 
когда калетта не лежит на оси симметрии огранки, необходимо вычислить уравнения плоскостей, в которых лежат эти грани. 
Затем, используя полученные уравнения, найти требуемые углы наклона граней. Если координаты вершин павильона найдены, 
то уравнение любой грани павильона находится элементарно – например, можно составить уравнение плоскости 
по трем вершинам павильона, принадлежащим грани для которой находится уравнение. 
Для задания смещения калетты относительно оси симметрии огранки используются два параметра (рис.<b>8</b>). 
Параметр <b>Culet offset</b> и  соответствующее ему поле <code>culet_R</code> в <b>СДМ</b> задает абсолютное значение 
расстояния центра калетты (или виртуальной калетты) до оси симметрии огранки.
Параметр <b>Culet offset azimuth</b> и соответствующее ему поле <code>culet_A</code> в <b>СДМ</b> задает азимут (угол) 
смещения центра калетты, отсчитываемый относительно координатных осей используемых при построении модели огранки.
</p>

<img src = "Figure_9_8.png" class="center-img" >

<p>
Параметр <b>Culet</b> (и  соответствующее ему поле <code>Culet</code> в <b>СДМ</b>) 
определяет размер грани калетты. Считается, что чем лучше по качеству бриллиант, 
тем меньше должна быть по размеру эта грань. У идеального бриллианта на месте этой грани находится 
одна вершина, называемая шипом огранки. Координаты шипа калетты совпадают с положением виртуальной калетты. 
Можно было бы при создании топологии огранки (при индексации ее вершин) для случая, когда огранка имеет шип, 
вместо грани калетты (калетта определена вершинами короны <b>8,9,10,11,12,13,14,15</b>), 
включить в массив <code>index_cut</code> всего одну вершину для шипа и соответствующим образом занумеровать вершины главных 
граней павильона. В дальнейшем мы так и будем поступать при построении подавляющего большинства других огранок. 
Однако чтобы показать, как это делается, модель огранки бриллианта построена с калеттой в виде грани, 
а не в виде шипа, но исходное значение поля <code>Culet</code> в <b>СДМ</b> задается равным очень малой величине, 
например, <b>0.0001</b>. Таким способом грань калетты фактически сводится в точку.
</p>
<p> 
Напомним, кстати (об этом уже говорилось), что в <b>dat.GUI</b> (по крайней мере в том варианте, которым я пользуюсь) 
по какой то причине нельзя корректно задать начальное значение <em><b>точно</em></b> равным нулю - 
не будет <em><b>отображаться</b></em> изменение параметра в горизонтальном столбике.
Хотя <em><b>само значение параметра</em></b> при этом <em><b>изменяется правильно</em></b>.
Возможно, что это <em>баг</em> программы и он будет в дальнейшем исправлен.
</p>
<p>
Обратим внимание на то, что очень не желательно задавать значение поля <code>Culet</code> равным <b>0</b>,  и по причине 
того, что тогда ребра в модели, ограничивающие грань калетты, превратятся в ребра, имеющие нулевую длину. 
Поэтому для того, чтобы этого не случилось, введена специальная проверка, 
которая не допускает нулевого размера калетты. 
Если же изначально известно, что размер калетты будет в любом случае очень малым по размеру, 
то повторим уже сказанное выше – лучше вместо грани калетты задать на этпе построения модели всего одну вершину – <em>шип</em>.
</p>

<p>
Параметр <b>Lower  facets depth</b> и  соответствующее ему поле <code>hPavFacet</code> в <b>СДО</b> 
задает глубину нижних вершин клиньев павильона. Легче всего дать определение этого параметра можно исходя 
из рассмотрения рисунке <b>5</b>. 
Параметр можно определить как  отношение равное <code>hPavFacet = hFacet / hPav</code>.
</p>

<p>
Перейдем к нахождению координат вершин павильона. Также как и в случае построения короны, все восемь плоскостей 
в которых лежат главные грани павильона (<b>a, b, c, d, e, f, g, h</b>) должны, если огранка построена правильно, 
пересекаться в одной точке. Эту точку, по аналогии с точкой <b>UpPoint</b> короны, обозначим как <b>DownPoint</b>. 
Ее еще называют <em>виртуальным шипом</em> огранки, если бриллиант имеет плоскость калетты, или, что, 
возможно, не совсем корректно – <em>виртуальной калеттой</em>.  Если плоскость калетты отсутствует, 
то положение точки <b>DownPoint</b> совпадает с шипом огранки и эту точку обычно называют просто калеттой 
без добавления прилагательного "виртуальная".
</p>

<img src = "Figure_9_9.png" class="center-img" >

<p>
Координаты точки <b>DownPoint</b> можно определить исходя из рассмотрения рис.<b>5</b>, на котором павильон огранки изображен для случая, 
когда эта точка пересечения плоскостей, в которых лежат главные грани павильона не смещена в горизонтальной 
плоскости <b>OXY</b> относительно оси симметрии огранки. Для этого случая координаты точки 
<b>DownPoint</b> равны  <em>(0,  0,  - (tan(alpha) / 2) - r/2)</em>.
</p>
<p>
На рисунке <b>9</b> изображена проекция павильона на горизонтальную плоскость. 
Для определения положения вершин павильона, нам необходимо найти уравнения восьми прямых, 
по которым пересекаются главные грани павильона. Прямая полностью определена, 
если на ней заданы координаты двух точек. В качестве первой точки для всех прямых можно взять точку <b>DownPoint</b>.  
В качестве вторых точек, через которые пройдут прямые, возьмем точки пересечения касательных 
проведенных к рундисту в его вершинах <b>64, 72, . . . 120</b>. На рисунке <b>8</b> это точки обозначены 
как <b>pt4, pt12, pt20, pt28, pt36, pt44, pt52</b> и <b>pt60</b>. Фактически нам даже не требуется вычислять 
положение этих точек пересечения касательных, так как их координаты по осям <b>OX</b> и <b>OY</b> совпадают 
с координатами соответствующих точек, полученных при построении короны. Точка пересечения плоскостей, 
в которых лежат главные грани павильона, и восемь точек в которых пересекаются касательные к рундисту, 
образуют восемь отрезков прямых заключенных между этими точками. Значения <code>hPavFacet</code> и <code>Culet</code> 
позволяют разделить эти отрезки в определенной пропорции и тем самым определяют положение нижних вершин 
клиньев павильона и вершин граней калетты. Далее приведена та часть функции <code>VerticesCalculation</code> 
в которой производится вычисление вершин павильона.
</p>
<pre class="prettyprint" id="quine">
	var hp = Math.tan(alpha) * (1-culet) / 2;
	var kollet = new Point3D(); // Это точка в которй сходятся все
	// все 8 плоскостей в которых лежат главные грани павильона
	kollet[0] = culet_R * Math.cos(culet_A);
	kollet[1] = culet_R * Math.sin(-culet_A);
	kollet[2] = - (Math.tan(alpha)/2) - r/2;

	//  Находим точки пересечения основных граней  
	// павильона между собой на уровне рундиста.
	// На самом деле это те же самые точки из массива <code>g2</code>,
	// которые мы определили при построении короны.
	// Поэтому при построении короны воспользуемся значениями 
	// из этого массива.
	for (i = 0; i < 8; i++)
	{
		var dir = new Vector3D(kollet[0] - g2[i][0], kollet[1] - g2[i][1], kollet[2] + r/2);

		var pav1 = new Point3D( kollet[0] - (1 - hPavFacet) * dir[0], 
					kollet[1] - (1 - hPavFacet) * dir[1],
					kollet[2] - (1 - hPavFacet) * dir[2]);
		pavil[i] = pav1;

		var pav2 = new Point3D( kollet[0] - culet * dir[0], 
					kollet[1] - culet * dir[1], 
					kollet[2] - culet * dir[2])
		pavil[8+i] = pav2;
	}
</pre>

<h3 align = "center">Альтернативный способ построения павильона огранки</h3>

<p>
Павильон огранки можно построить и другими способами, которые отличаются от выше приведенного. 
Рассмотрим один из них. Выберем узловую вершину рундиста с номером <b>64</b> со стороны павильона, 
лежащую в том месте огранки, где измеряется ее главный диаметр. Проведем через эту вершину 
плоскость определенную вектором, расположенным касательно к рундисту в этой вершине 
(этот вектор, при используемой системе координат, проходит параллельно оси <b>OX</b>), 
и имеющую наклон равный значению параметра <b>Pavilion angle</b>. Найдем координаты точки пересечения 
вертикальной прямой, проходящей через начало координат, с этой плоскостью. Примем эту точку за шип огранки.  
Если огранка имеет грань калетты, то эта точка может рассматриваться как виртуальный шип 
(виртуальная калетта) огранки. Зная координаты шипа огранки, 
мы можем найти значение глубины павильона огранки <b>hp</b>. Предыдущие действия мы проводили в предположении, 
что смещение виртуального шипа огранки в горизонтальной плоскости нет. 
</p>

<p>
Допустим, что теперь шип огранки в общем случае смещен в горизонтальной плоскости относительно начала координат. 
При этом его координаты станут равными <code>(CuletX, CuletY, hp+r/2)</code>, 
где значение r  является толщиной рундиста. Затем через вершины рундиста <b>64, 72, 80, 88, 96, 104, 112</b> и <b>120</b> 
проведем восемь плоскостей. Положение каждой из них в пространстве определяется, 
кроме названных вершин рундиста, еще направлениями двух векторов. 
Один вектор – это вектор соединяющий шип огранки с соответствующей вершиной рундиста.  
Направление другого вектора задается касательной к рундисту, проходящей через его соответствующую вершину. 
Пример этому – вектор, проходящий через шип и вершину рундиста <b>72</b>, 
и вектор касательный к рундисту в этой же вершине рундиста <b>72</b>, задают положение плоскости, 
в которой лежит главная грань павильона проходящая через вершину <b>72</b>. 
Для определения координат нижних вершин клиньев павильона, находятся точки пересечения плоскостей, 
в которых лежат главные грани павильона, с горизонтальной плоскостью, проведенной на уровне этих вершин. 
Такой способ расчета координат вершин павильона мы будем довольно часто использовать 
в других огранках – маркиз, груша и павильон.
</p>
<p> 
Особенно удобно его использовать – но с некоторыми изменениями – при расчете координат вершин павильона 
огранок с так называемыми лунными гранями. Похожий способ можно применить и к расчету координат вершин короны огранки.
</p>

<h3 align = "center">Корректировка высот вершин рундиста бриллианта</h3>
<p>
После того как вершины короны и павильона определены, требуется провести корректировку вершин рундиста.
С этой целью проводятся вертикальные прямые через все вершины рундиста(кроме узловых - <b>0, 4, ..., 60, 64, ..., 124</b>).
Затем находятся точки <em>протыкания</em> этими прямыми граней корона и павильона. Координаты этих
точек будут являться новыми <em>скорректированными</em> координатами вершин рундиста.
</p>

<p>
Однако для бриллианта можно перед описанной корректировкой провести некоторые предварительные действия. 
<em>Протыкание</em> будет осуществляться через немного измененное положение граней короны и павильона.
Рассмотрим это подробнее.
</p>
<img src = "Figure_9_10.png" class="center-img" >
<p>
Предпочтительно, чтобы бриллиант имел как можно более равномерный по толщине рундист. 
Для регулировки толщины рундиста в модель бриллианта можно ввести два специальных параметра – один параметр 
позволяет изменять азимут нижних клиньев короны, а другой изменяет азимут клиньев павильона (рисунок <b>10</b>). 
Если изменить азимут грани <b>C2</b> короны, то тем самым изменится высота вершины рундиста выделенная прямогольником, 
а если изменить азимут грани <b>c2</b> павильона, то изменится глубина вершины рундиста выделенная овалом.
В модели бриллианта параметр <b>Upper azimuth</b>, которому соответствует поле <code>up_az</code> в <b>СДМ</b>, 
позволяет задавать азимуты нижних клиньев короны.
Параметр <b>Lower azimuth</b> (этому параметру в <b>СДМ</b> соответствует поле <code>low_az</code>) 
позволяет задавать азимуты клиньев павильона.
</p>
<p>
Рассмотрим, как осуществляется задание нового значения азимута для клина короны. 
В результате работы функции <code>InitGirdle</code> высоты всех вершин рундиста со стороны короны получают значения равные <b>r/2</b>, 
а глубины всех вершин рундиста со стороны павильона получают значения равные  <b>–r/2</b>.  
Допустим, происходит установка азимута грани <b>C2</b>. Сначала создаем вектор, лежащий в  горизонтальной плоскости.  
Направление вектора задается новым значением азимута, которое требуется установить для грани клина 
(на рисунке <b>10</b> этот вектор не показан). 
Затем создается еще один вектор, направление которого совпадает с направлением ребра соединяющего вершину короны <b>10</b> 
и вершину рундиста <b>16</b>. Используя эти два вектора, можно создать уравнение плоскости, 
в которой лежит грань <b>C2</b> с заданным значением азимута. Уравнение будет определено двумя построенными 
векторами и вершиной рундиста <b>16</b>. 
Зная уравнение плоскости, в которой лежит грань <b>C2</b>, мы легко можем найти новую высоту вершины рундиста <b>20</b> 
(вершина обведена прямоугольником на рис.<b>9</b>). Таким же образом можно найти высоты вершин рундиста 
<b>4, 12, 28, 36, 44, 52</b> и <b>60</b>. 
Корректировка глубин вершин рундиста <b>68, 76, . . . 124</b> со стороны павильона осуществляется точно таким же образом 
как это сделано для высот вершин рундиста со стороны короны.
</p>

<p>
Назовем узловыми вершинами рундиста те его вершины, к которым подходят ребра короны или павильона. 
Со стороны короны узловыми вершинами рундиста являются вершины <b>0, 4, 8, . . . 60</b>, 
а со стороны павильона –  вершины <b>64, 68, 72, . . . 124</b>. Далее приводится исходный текст той части функции 
<code>VerticesCalculation</code>, где выполняются описанные действия по изменению глубины тех узловых вершин рундиста, 
в которых сходятся нижние клинья короны (для павильона расчет призводится аналогично).
</p>
<pre class="prettyprint" id="quine">
	// Строим вектор по направлению равному заданному азимуту up_az
	var vec_crown_1 = new Vector3D(-Math.tan(up_az), -1.0, 0.0);
	vec_crown_1.Normer();
	
	// Строим еще один вспомогательный вектор, имеющей такое же
	// направление, что и направление ребра проходящего 
	// через вершину 10 короны и вершину рундиста 16.
	var vec_crown_2 = new Vector3D(
					crown[10][0] - girdle[16][0], 
					crown[10][1] - girdle[16][1], 
					crown[10][2] - girdle[16][2]);	
	vec_crown_2.Normer();
	
	// Находим вектор перпендикулярный векторам vec_crown_1 и vec_crown_2
	var vec_norm = vec_crown_1.Cross(vec_crown_2);
	vec_norm.Normer();
	
	// Создаем плоскость в которой лежит грань C2 короны с заданным азимутом
	var plane = new Plane3D();
	plane.CreatePlaneNormalVectorPoint(vec_norm, girdle[16]);
	
	// Создаем вертикальную прямую проходящую через вершину 20 рундиста
	var line_crown = new Line3D();
	line_crown.CreateLineVectorPoint(Z0, girdle[20]);
	
	// Точка пересечения 
	var point = line_crown.IntersectionLinePlane(plane);
	
	// Разница между старой и новой высотой вершины 20 рундиста
	var del = -(girdle[20][2] - point[2]);
	
	// Корректируем высоты вершин рундиста 4, 12, 20, 28, 36, 44, 52 и 60
	for (i = 4; i < 64; i = i + 8)
	{
		girdle[i][2] = girdle[i][2] + del;
	}
</pre>
<p>
Заметим, что можно непосредственно задать требуемую величину высот указанных вершин короны и павильона напрямую, 
а не путем изменения азимута клиньев короны и павильона. В этом случае значения азимутов соответствующих клиньев 
будут являться величинами, производными от значений высот (или <em>глубин</em>)  рундиста в соответствующих вершинах огранки.
Это более простой способ. Поэтому в дальнейшем при построении большинства огранок других типов отличных от 
огранки бриллиант мы не будем привязывать глубину соответствующих вершин рундиста к азимуту клиньев, 
а будем, если это требуется, напрямую изменять значение глубин этих вершин.
</p>

<h3 align = "center">Вычисляемые параметры модели</h3>
<p>
Кроме упомянутого ранее параметра <b>Star facets</b> у огранки бриллиант есть и другие вычисляемые параметры.  
Так как в СДМ не присутствует параметров для значений высоты короны и глубины павильона, 
то вводятся соответствующие вычисляемые параметры <b>Crown height</b> и <b>Pavilion depth</b>. При использовании этих параметров, 
а также параметров задающих углы наклона граней павильона и короны, следует принять во внимание соображение, 
которое заключается в том, что изменять высоту короны или глубину павильона можно двумя способами.
</p>
<p> 
При использовании первого способа изменяется угол короны или павильона, а затем производится расчет нового положения вершин огранки.<br> 
При использовании второго способа – пропорционально изменяются высоты всех вершин короны или павильона.  
Фактически, при этом способе происходит растяжение (сжатие) короны или павильона вдоль оси <b>OZ</b>.
</p> 
<p> 
Очевидно, что при правильном использовании второго способа, ограничением для величины растяжения является только значение толщины рундиста, 
если принять, что его толщина в узловых вершинах остается постоянной при этих изменениях.  
Положение вершин рундиста в горизонтальной плоскости остается неизменным при обоих способах изменения высоты короны или глубины павильона, 
но высота вершин рундиста лежащих между его узловыми вершинами изменится, так как меняется наклон граней короны или павильона.
Для рассматриваемой огранки бриллиант, в силу особенностей его формы 
(главные грани павильона начинаются у рундиста и заканчиваются у горизонтальной плоскости калетты, 
ограничивающих огранку сверху, а значения <code>hPavFacet</code>  и <code>culet</code> заданы относительно глубины павильона), 
оба способа изменения глубины павильона являются эквивалентными с точки того, как они изменяют форму павильона.
Но для других огранок эти способы изменения обычно приводят к разным результатам и, поэтому об этом не следует забывать. 
</p>
<p>
Сложнее дело обстоит с короной бриллианта. Это связано с тем, что (хотя главные грани короны начинаются у рундиста, 
а заканчиваются у верхней горизонтальной плоскости огранки площадки), размер площадки задан относительно ширины огранки. 
Три параметра короны – высота короны, угол короны и размер площадки – жестко завязаны между собой.
Изменяя высоту короны, можно оставить неизменным или размер площадки, или угол наклона короны. 
Если мы изменяем угол короны огранки, то можно оставить неизменным или размер площадки или высоту короны. 
Если же производится изменение размера площадки, то можно оставить неизменной или высоту короны или оставить неизменным угол короны.
В соответствии с указанными вариантами производится выбор параметров короны – можно при выборе ввести параметры 
либо для всех возможных вариантов, либо только для их части. 
В данной огранке принято два варианта изменения угла короны огранки.<br> 
&emsp;При первом варианте его изменения (параметр  – <b>Crown angle</b>) размер площадки остается неизменной, 
а высота короны при изменении ее угла меняется.<br> 
&emsp;При втором варианте изменения  угла короны (параметр – <b>Crown angle uHFix</b>) высота короны 
остается неизменной, а размер площадки меняется. 
</p>
<p>
Рассмотрим вычисляемые параметры, которые относятся к павильону. 
Как уже было сказано при рассмотрении процесса построения павильона огранки, для позиционирования калетты используются 
два параметра и каждый из них представлен своим полем в <b>СДМ</b>. Параметр <b>Culet offset</b> 
задает отклонение калетты от оси симметрии огранки, а параметр <b>Culet offset azimuth</b> задает азимут центра калетты.
</p>
<p> 
При использовании модели огранки удобно иметь еще значения отклонения центра калетты от осей <b>OX</b> и <b>OY</b> огранки. 
Поэтому в огранку введены два вычисляемых параметра <b>Culet X</b> и <b>Culet Y</b>, 
которые позволяют получить эти два отклонения. 
Значения, получаемые при помощи параметров <b>Culet X</b> и <b>Culet Y</b>, рассчитываются исходя из текущих 
значений <b>culet_R</b> и <b>culet_A</b>. 
Для обращения к параметрам <b>Culet X</b> и <b>Culet Y</b> в панели отображения используются идентификаторы 
<code>сulet_offsetX</code> и <code>culet_offsetY</code>.
<br> 
&emsp; Огранка бриллиант является, пожалуй, единственной огранкой в которой для задания положения 
калетты используются параметры <b>Culet offset</b> и <b>Culet offset azimuth</b> 
и для них при этом присутствуют поля в <b>СДМ</b>. Введение этих параметров объясняется тем, что в отличие от
других огранок, бриллиант в большинстве случаев является круглым (по рундисту) многогранником и поэтому 
введение параметра <b>Culet offset azimuth</b> выглядит гармонично.
В огранках других типов для задания положения калетты обычно используются параметры <b>Culet X</b> и <b>Culet Y</b> 
с соответствующими полями в <b>СДМ</b>.
</p>

<p>
Особо следует отметить параметр <b>Total height</b> (в панели управления ему соответствует <code>full_height</code>), 
который пропорционально растягивает/сжимает одновременно корону, рундист и павильон вдоль оси <b>Z</b>. 
Иными словами он осуществляет пропорциональное изменение размеров всей модели целиком вдоль этой оси. 
Исходный текст с помощью которого осуществляется установка значений параметров находится в файле <b>brilliant.js</b>.
<p> 

<h3 align = "center">Краткое резюме по модели огранки бриллиант</h3>

<img src = "figure_9_11.png" class="center-img" >
<p>
Метод построения модели бриллианта значительно отличается от тех способов построения, 
которые мы будем использовать при создании других моделей огранок.  Процесс построения  короны и павильона модели бриллианта, 
условно говоря, отражает внутреннюю сущность геометрии бриллианта. При построении его короны мы не строили ее грани 
по отдельности для того чтобы найти положение вершин, а просто воспользовались тем фактом, что плоскости, 
в которых лежат главные грани короны, пересекаются в одной точке. Используя это свойство огранки, 
можно без большого труда построить корону огранки и найти координаты всех ее вершин исходя из решения 
простейших пропорций связывающих элементы короны между собой.
</p>
<p> 
Похожим образом обстоит дело и при построении павильона огранки – все плоскости, в которых лежат главные грани павильона, 
также как и при построении короны,  пересекаются в одной точке, которая обозначена на рисунке <b>11</b> цифрой <b>1</b>. 
Даже если сместить положение координат <b>x</b> и <b>y</b> этой точки <b>1</b> таким образом, чтобы она перестала находиться 
на оси симметрии огранки (смещение калетты огранки)  то, даже в этом случае, павильон будет построен правильно, 
так как главные грани павильона при таком смещении калетты не ломаются. Это объясняется тем, что фактически, 
каждая из восьми основных граней павильона (например, грань <b>b</b>) определена двумя точками – точкой <b>1</b> 
пересечения плоскостей, в которых лежат главные грани павильона и соответствующей узловой вершиной рундиста, 
которая на рисунке <b>11</b> обозначена цифрой <b>2</b>. 
<br>
&emsp;Кроме положения этих двух вершин для каждой основной грани павильона требуется задать еще и азимут 
соответствующей грани.  Но не сложно понять, что азимут главных граней павильона для модели огранки с круглым 
рундистом  определяется только количеством главных граней павильона и этот азимут не меняется, 
ни при изменении положения калетты, ни при изменении значения параметра <b>hPavFacet</b>. 
Азимут основных граней павильона зависит только от удлинения огранки <b>lw</b> и параметра, 
определяющего квадратичность рундиста (если он отличен от нуля). 
</p>
<p> 
Заметим еще, что при смещении калетты все не узловые вершины рундиста со стороны павильона получат 
новые значения своей глубины, а узловые вершины рундиста не изменят свое положение по глубине.
Сказанное выше можно пояснить следующим образом. Предположим, что мы имеем проволочную модель огранки бриллиант. 
В этой модели каждому ребру огранки соответствует отрезок проволоки. Также предположим, что размер плоскости калетты 
стремится к нулевому значению. Если мы возьмемся рукой за шип огранки (точка <b>DownPoint</b> на рисунке <b>5</b>) 
и начнем его смещать в горизонтальной плоскости в произвольном направлении, 
то хотя наклоны всех граней составляющих павильон будут меняться, но азимуты граней останутся неизменными. 
При этом делается допущение, что ребра граней проволочной огранки могут сжиматься или растягиваться соответствующим образом. 
Хотя при построении короны огранки бриллиант мы не предполагаем возможность ее смещения, но то же самое произойдет и с гранями короны, 
если мы возьмемся рукой за несуществующую на самом деле точку <b>UpPoint</b> короны и начнем смещать ее в горизонтальной плоскости. 
Подобное поведение модели мы уже рассматривали при построении огранки <em>октагон</em> в главе <b>6</b>.
</p>

<h3 align = "center">&emsp;&emsp;
<a href="../Octagon/Chapter_08.html"> <span class=brown>Глава 8 </span></a>  <span class=brown>&ensp;◄</span>
&emsp;&emsp;&emsp;
<a href="../index.html"> <span class=brown> Содержание  </span></a>
&emsp;&emsp;&emsp;
 <span class=brown>► &ensp;</span><a href="../Sunflower/Chapter_10.html"> <span class=brown> Глава 10  </span></a>
</h3>

</body>
</html>
